# Исправление проблемы с командой /start

## Проблема
Бот не отвечает на команду `/start`.

## Что было исправлено

1. **Обработчик команды /start теперь обрабатывается первым** - независимо от текущей сцены пользователя (SUPPORT, CREATING_ORDER и т.д.)
2. **Добавлено детальное логирование** - теперь в логах видно, когда команда /start получена и обработана
3. **Сброс состояния пользователя** - при вызове /start состояние пользователя сбрасывается

## Как проверить исправление

### 1. Пересобрать и перезапустить сервер

```bash
cd bot/server
npm run build
# Перезапустите сервер (PM2 или другой процесс-менеджер)
pm2 restart bot-server
# или
npm start
```

### 2. Проверить логи

Отправьте команду `/start` боту и проверьте логи сервера. Вы должны увидеть:

```
[WEBHOOK-CLIENT] ========== WEBHOOK REQUEST RECEIVED ==========
[DEBUG] /start command received from chatId: <ID>, userId: <ID>, current scene: <SCENE>
[DEBUG] /start command response sent: true
```

### 3. Проверить webhook

Используйте скрипт для проверки статуса webhook:

```bash
cd deployment
./check_webhook_status.sh
```

Или вручную:

```bash
# Замените <CLIENT_BOT_TOKEN> на ваш токен
curl "https://api.telegram.org/bot<CLIENT_BOT_TOKEN>/getWebhookInfo"
```

### 4. Если webhook не настроен

Если webhook не настроен, установите его:

```bash
# Замените <CLIENT_BOT_TOKEN> и <YOUR_DOMAIN> на ваши значения
curl -F "url=https://<YOUR_DOMAIN>/webhook/<CLIENT_BOT_TOKEN>" \
     https://api.telegram.org/bot<CLIENT_BOT_TOKEN>/setWebhook
```

Например:
```bash
curl -F "url=https://plagiatanet.by/webhook/8531679123:AAHYeJe5Qu6mdohlMj-VDOp2579tD8OYveo" \
     https://api.telegram.org/bot8531679123:AAHYeJe5Qu6mdohlMj-VDOp2579tD8OYveo/setWebhook
```

## Возможные проблемы

### Проблема 1: Webhook не получает запросы

**Симптомы:**
- В логах нет записей `[WEBHOOK-CLIENT]`
- Бот вообще не отвечает

**Решение:**
1. Проверьте, что сервер запущен и доступен
2. Проверьте, что webhook URL правильный
3. Проверьте настройки Nginx (если используется)

### Проблема 2: Ошибки при отправке сообщения

**Симптомы:**
- В логах есть `[ERROR] safeSendMessage: Failed to send`
- Команда /start получена, но ответ не отправлен

**Решение:**
1. Проверьте, что `CLIENT_BOT_TOKEN` правильный
2. Проверьте, что бот не заблокирован пользователем
3. Проверьте права бота

### Проблема 3: Команда обрабатывается, но ответ не приходит

**Симптомы:**
- В логах видно, что команда обработана
- Но пользователь не получает ответ

**Решение:**
1. Проверьте логи на наличие ошибок
2. Проверьте, что `safeSendMessage` возвращает `true`
3. Проверьте сетевые настройки

## Дополнительная диагностика

Если проблема не решена, включите более детальное логирование:

1. Убедитесь, что в коде есть логирование (уже добавлено)
2. Проверьте логи сервера в реальном времени:
   ```bash
   # Для PM2
   pm2 logs bot-server
   
   # Для обычного запуска
   npm start
   ```

3. Отправьте команду `/start` и следите за логами

## Контакты

Если проблема не решена, проверьте:
- Логи сервера на наличие ошибок
- Статус webhook через Telegram API
- Доступность сервера извне

